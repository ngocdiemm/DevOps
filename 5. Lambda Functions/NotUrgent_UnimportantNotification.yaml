import boto3
import json
import random
from datetime import datetime, timedelta

# Khá»Ÿi táº¡o káº¿t ná»‘i Ä‘áº¿n DynamoDB
dynamodb = boto3.client('dynamodb')

# Khá»Ÿi táº¡o káº¿t ná»‘i Ä‘áº¿n Cognito
cognito = boto3.client('cognito-idp', region_name='ap-southeast-1')

# Khá»Ÿi táº¡o káº¿t ná»‘i Ä‘áº¿n SNS
sns_client = boto3.client('sns', region_name='ap-southeast-1')

# Biáº¿n mÃ´i trÆ°á»ng
USER_POOL_ID = 'ap-southeast-1_eJfA6tF52'
TOPIC_ARN = 'arn:aws:sns:ap-southeast-1:226719017722:MyTaskReminderNotification'

def get_user_name(user_id):
    try:
        response = cognito.admin_get_user(
            UserPoolId=USER_POOL_ID,
            Username=user_id
        )
        for attr in response['UserAttributes']:
            if attr['Name'] == 'email':
                return attr['Value'], ""
        return None, response
    except Exception as e:
        print(f"Error getting user name: {str(e)}")
        return None, f"Error getting user name: {str(e)}"

def send_notification(user_name, EventDate, message):
    # TÃ­nh toÃ¡n thá»i gian cáº§n gá»­i thÃ´ng bÃ¡o (trÆ°á»›c 5 tiáº¿ng)
    send_time = EventDate - timedelta(hours=5)

    try:
        sns_client.publish(
            TopicArn=TOPIC_ARN,
            Message=message,
            MessageAttributes={
                'ScheduledTime': {
                    'DataType': 'String',
                    'StringValue': send_time.strftime('%Y-%m-%dT%H:%M:%S')
                }
            }
        )
        print(f"Notification sent to {user_name}")
    except Exception as e:
        print(f"Error sending notification: {str(e)}")

def lambda_handler(event, context):
    user_id = event['UserId']
    user_name, err = get_user_name(user_id)
    if user_name is None:
        return {
            'statusCode': 500,
            'msg': json.dumps(str(err))
        }
    selected_datetime_str = event['EventDate']  # NgÃ y vÃ  giá» Ä‘Æ°á»£c chá»n bá»Ÿi ngÆ°á»i dÃ¹ng
    selected_datetime = datetime.strptime(selected_datetime_str, '%B %d, %Y')

    message = random.choice([
        f"Dear {user_name}, ğŸš« Is it really necessary? Consider if these non-urgent, unimportant tasks are worth your time.",
        f"Dear {user_name}, ğŸš« Be mindful of your time and energy. Avoid getting caught up in non-urgent, unimportant tasks.",
        f"Dear {user_name}, ğŸš« Focus on what truly matters. Skip those non-urgent, unimportant tasks if possible."
    ])

    send_notification(user_name, selected_datetime, message)

    return {
        'statusCode': 200,
        'body': json.dumps('ThÃ´ng bÃ¡o Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t lá»‹ch gá»­i thÃ nh cÃ´ng.')
    }
